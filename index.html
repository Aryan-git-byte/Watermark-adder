<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="tailwind-config" content="{'mode': 'jit'}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Watermark Pro - Free Watermarking Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.15);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .dark .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
        }

        .preview-container {
            min-height: 400px;
            background-image:
                linear-gradient(45deg, #f8f9fa 25%, transparent 25%),
                linear-gradient(-45deg, #f8f9fa 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #f8f9fa 75%),
                linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            position: relative;
            overflow: hidden;
        }

        .dark .preview-container {
            background-image:
                linear-gradient(45deg, #2d3748 25%, transparent 25%),
                linear-gradient(-45deg, #2d3748 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #2d3748 75%),
                linear-gradient(-45deg, transparent 75%, #2d3748 75%);
        }

        .watermark-overlay {
            position: absolute;
            cursor: move;
            border: 2px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            min-height: 20px;
            transition: none; /* Remove transitions to prevent flickering */
        }

        .watermark-overlay:hover {
            border-color: #4f46e5;
            background: rgba(102, 126, 234, 0.2);
        }

        .watermark-overlay.dragging {
            cursor: grabbing;
            border-color: #4f46e5;
            background: rgba(102, 126, 234, 0.3);
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .resize-handle:hover {
            background: #4f46e5;
            transform: scale(1.2);
        }

        .resize-handle.nw {
            top: -6px;
            left: -6px;
            cursor: nw-resize;
        }

        .resize-handle.ne {
            top: -6px;
            right: -6px;
            cursor: ne-resize;
        }

        .resize-handle.sw {
            bottom: -6px;
            left: -6px;
            cursor: sw-resize;
        }

        .resize-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }

        .rotate-handle {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background: #10b981;
            border: 2px solid white;
            border-radius: 50%;
            cursor: grab;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .rotate-handle:hover {
            background: #059669;
            transform: translateX(-50%) scale(1.2);
        }

        .rotate-handle:active {
            cursor: grabbing;
        }

        .font-item {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .font-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .dark .font-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .text-primary {
            color: #1f2937;
        }

        .dark .text-primary {
            color: #f9fafb;
        }

        .text-secondary {
            color: #4b5563;
        }

        .dark .text-secondary {
            color: #d1d5db;
        }

        .text-tertiary {
            color: #6b7280;
        }

        .dark .text-tertiary {
            color: #9ca3af;
        }

        .input-field {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1f2937;
        }

        .dark .input-field {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f9fafb;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Initialize pdf.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const WatermarkApp = () => {
            const [darkMode, setDarkMode] = useState(() => {
                if (typeof window !== 'undefined') {
                    return window.matchMedia('(prefers-color-scheme: dark)').matches;
                }
                return false;
            });
            const [files, setFiles] = useState([]);
            const [watermarkType, setWatermarkType] = useState('text');
            const [watermarkText, setWatermarkText] = useState('WATERMARK');
            const [watermarkImage, setWatermarkImage] = useState(null);
            const [selectedFont, setSelectedFont] = useState('Roboto');
            const [fontSize, setFontSize] = useState(48);
            const [fontColor, setFontColor] = useState('#000000');
            const [opacity, setOpacity] = useState(50);
            const [rotation, setRotation] = useState(0);
            const [bold, setBold] = useState(false);
            const [italic, setItalic] = useState(false);
            const [letterSpacing, setLetterSpacing] = useState(0);
            const [position, setPosition] = useState('center');
            const [tiled, setTiled] = useState(false);
            const [layerMode, setLayerMode] = useState('above');
            const [processing, setProcessing] = useState(false);
            const [currentPreview, setCurrentPreview] = useState(0);
            const [previewUrls, setPreviewUrls] = useState([]);
            const [loadedFonts, setLoadedFonts] = useState(new Set(['Roboto']));
            const [searchFont, setSearchFont] = useState('');
            const [googleFonts, setGoogleFonts] = useState([]);
            const [loadingFonts, setLoadingFonts] = useState(false);
            const [manualMode, setManualMode] = useState(false);
            const [watermarkTransform, setWatermarkTransform] = useState({
                x: 50,
                y: 50,
                width: 200,
                height: 50,
                rotation: 0
            });
            const [isDragging, setIsDragging] = useState(false);
            const [isResizing, setIsResizing] = useState(false);
            const [isRotating, setIsRotating] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });

            const fileInputRef = useRef(null);
            const logoInputRef = useRef(null);
            const canvasRef = useRef(null);
            const previewContainerRef = useRef(null);
            const watermarkRef = useRef(null);

            // Auto theme detection
            useEffect(() => {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const handleChange = (e) => setDarkMode(e.matches);
                mediaQuery.addEventListener('change', handleChange);
                return () => mediaQuery.removeEventListener('change', handleChange);
            }, []);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
                loadGoogleFonts();
            }, [darkMode]);

            // Fetch Google Fonts dynamically
            const loadGoogleFonts = async () => {
                setLoadingFonts(true);
                try {
                    // Fallback to a comprehensive font list
                    const fallbackFonts = [
                        'Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Oswald', 'Raleway', 'Poppins', 'Source Sans Pro',
                        'Slabo 27px', 'Merriweather', 'Playfair Display', 'PT Sans', 'PT Serif', 'Ubuntu', 'Libre Baskerville',
                        'Nunito', 'Work Sans', 'Crimson Text', 'Quicksand', 'Mukti', 'Arimo', 'Lora', 'PT Sans Caption',
                        'Droid Sans', 'Droid Serif', 'Inconsolata', 'Cabin', 'Bitter', 'Noto Sans', 'Dosis', 'Abel',
                        'Fjalla One', 'Libre Franklin', 'Oxygen', 'Karla', 'Righteous', 'Dancing Script', 'Pacifico',
                        'Shadows Into Light', 'Indie Flower', 'Lobster', 'Great Vibes', 'Sacramento', 'Satisfy', 'Kaushan Script',
                        'Amatic SC', 'Caveat', 'Courgette', 'Handlee', 'Yellowtail', 'Abril Fatface', 'Anton', 'Russo One',
                        'Bebas Neue', 'Fredoka One', 'Alfa Slab One', 'Bungee', 'Creepster', 'Orbitron', 'Audiowide',
                        'Black Ops One', 'Monoton', 'Stardos Stencil', 'Nixie One', 'Syncopate', 'Cinzel', 'Cormorant Garamond',
                        'EB Garamond', 'Crimson Pro', 'Spectral', 'Vollkorn', 'Gelasio', 'Old Standard TT', 'Cormorant',
                        'Alegreya', 'Domine', 'Neuton', 'Cardo', 'Gentium Plus', 'Poly', 'Goudy Bookletter 1911',
                        'Inter', 'DM Sans', 'Plus Jakarta Sans', 'Outfit', 'Space Grotesk', 'Sora', 'Epilogue', 'Manrope'
                    ];
                    setGoogleFonts(fallbackFonts.map(name => ({ family: name, category: 'sans-serif' })));
                } catch (error) {
                    console.error('Failed to load Google Fonts:', error);
                }
                setLoadingFonts(false);
            };

            const loadGoogleFont = async (fontName) => {
                if (loadedFonts.has(fontName)) return;

                const link = document.createElement('link');
                link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(' ', '+')}:wght@400;700&display=swap`;
                link.rel = 'stylesheet';
                document.head.appendChild(link);

                setLoadedFonts(prev => new Set([...prev, fontName]));
            };

            const handleFileUpload = (e) => {
                const uploadedFiles = Array.from(e.target.files);
                const validFiles = uploadedFiles.filter(file => {
                    const type = file.type.toLowerCase();
                    return type === 'application/pdf' ||
                        type === 'image/jpeg' ||
                        type === 'image/jpg' ||
                        type === 'image/png';
                });

                setFiles(validFiles);
                generatePreviews(validFiles);
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setWatermarkImage(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const generatePreviews = async (fileList) => {
                const urls = [];
                for (const file of fileList) {
                    if (file.type === 'application/pdf') {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                        const page = await pdf.getPage(1);
                        const scale = 1.5;
                        const viewport = page.getViewport({ scale });

                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;

                        urls.push(canvas.toDataURL());
                    } else {
                        urls.push(URL.createObjectURL(file));
                    }
                }
                setPreviewUrls(urls);
            };

            // Manual watermark controls
            const handleWatermarkMouseDown = (e) => {
                if (e.target.classList.contains('resize-handle')) return;
                if (e.target.classList.contains('rotate-handle')) return;

                setIsDragging(true);
                const rect = previewContainerRef.current.getBoundingClientRect();
                setDragStart({
                    x: e.clientX - rect.left - watermarkTransform.x,
                    y: e.clientY - rect.top - watermarkTransform.y
                });
            };

            const handleMouseMove = (e) => {
                if (!previewContainerRef.current) return;
                const rect = previewContainerRef.current.getBoundingClientRect();

                if (isDragging) {
                    const newX = e.clientX - rect.left - dragStart.x;
                    const newY = e.clientY - rect.top - dragStart.y;

                    setWatermarkTransform(prev => ({
                        ...prev,
                        x: Math.max(0, Math.min(rect.width - prev.width, newX)),
                        y: Math.max(0, Math.min(rect.height - prev.height, newY))
                    }));
                }
            };

            const handleMouseUp = () => {
                setIsDragging(false);
                setIsResizing(false);
                setIsRotating(false);
            };

            useEffect(() => {
                if (manualMode) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);

                    return () => {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    };
                }
            }, [isDragging, isResizing, isRotating, dragStart, manualMode]);

            const getWatermarkPosition = (canvasWidth, canvasHeight, watermarkWidth, watermarkHeight, pos) => {
                if (manualMode) {
                    const scaleX = canvasWidth / (previewContainerRef.current?.clientWidth || 1);
                    const scaleY = canvasHeight / (previewContainerRef.current?.clientHeight || 1);
                    return {
                        x: watermarkTransform.x * scaleX,
                        y: watermarkTransform.y * scaleY
                    };
                }

                const padding = 20;
                switch (pos) {
                    case 'top-left':
                        return { x: padding, y: padding };
                    case 'top-center':
                        return { x: (canvasWidth - watermarkWidth) / 2, y: padding };
                    case 'top-right':
                        return { x: canvasWidth - watermarkWidth - padding, y: padding };
                    case 'center-left':
                        return { x: padding, y: (canvasHeight - watermarkHeight) / 2 };
                    case 'center':
                        return { x: (canvasWidth - watermarkWidth) / 2, y: (canvasHeight - watermarkHeight) / 2 };
                    case 'center-right':
                        return { x: canvasWidth - watermarkWidth - padding, y: (canvasHeight - watermarkHeight) / 2 };
                    case 'bottom-left':
                        return { x: padding, y: canvasHeight - watermarkHeight - padding };
                    case 'bottom-center':
                        return { x: (canvasWidth - watermarkWidth) / 2, y: canvasHeight - watermarkHeight - padding };
                    case 'bottom-right':
                        return { x: canvasWidth - watermarkWidth - padding, y: canvasHeight - watermarkHeight - padding };
                    case 'diagonal':
                        return { x: (canvasWidth - watermarkWidth) / 2, y: (canvasHeight - watermarkHeight) / 2, diagonal: true };
                    default:
                        return { x: (canvasWidth - watermarkWidth) / 2, y: (canvasHeight - watermarkHeight) / 2 };
                }
            };

            const applyWatermarkToCanvas = (ctx, width, height) => {
                ctx.save();
                ctx.globalAlpha = opacity / 100;

                if (layerMode === 'blended') {
                    ctx.globalCompositeOperation = 'multiply';
                }

                if (watermarkType === 'text') {
                    const fontWeight = bold ? 'bold' : 'normal';
                    const fontStyle = italic ? 'italic' : 'normal';
                    const actualFontSize = manualMode ? (fontSize * watermarkTransform.width / 200) : fontSize;
                    ctx.font = `${fontStyle} ${fontWeight} ${actualFontSize}px '${selectedFont}'`;
                    ctx.fillStyle = fontColor;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    if (letterSpacing !== 0) {
                        ctx.letterSpacing = `${letterSpacing}px`;
                    }

                    if (tiled) {
                        const spacing = actualFontSize * 3;
                        for (let x = 0; x < width; x += spacing) {
                            for (let y = 0; y < height; y += spacing) {
                                ctx.save();
                                ctx.translate(x, y);
                                ctx.rotate((rotation * Math.PI) / 180);
                                ctx.fillText(watermarkText, 0, 0);
                                ctx.restore();
                            }
                        }
                    } else {
                        const metrics = ctx.measureText(watermarkText);
                        const textHeight = actualFontSize;
                        const pos = getWatermarkPosition(width, height, metrics.width, textHeight, position);

                        ctx.translate(pos.x + metrics.width / 2, pos.y + textHeight / 2);
                        const finalRotation = manualMode ? watermarkTransform.rotation : (pos.diagonal ? -45 : rotation);
                        if (finalRotation !== 0) {
                            ctx.rotate((finalRotation * Math.PI) / 180);
                        }
                        ctx.fillText(watermarkText, 0, 0);
                    }
                } else if (watermarkType === 'image' && watermarkImage) {
                    const img = new Image();
                    img.src = watermarkImage;

                    return new Promise((resolve) => {
                        img.onload = () => {
                            const imgWidth = manualMode ? watermarkTransform.width : fontSize * 2;
                            const imgHeight = manualMode ? watermarkTransform.height : (img.height / img.width) * imgWidth;

                            if (tiled) {
                                const spacing = imgWidth * 2;
                                for (let x = 0; x < width; x += spacing) {
                                    for (let y = 0; y < height; y += spacing) {
                                        ctx.save();
                                        ctx.translate(x + imgWidth / 2, y + imgHeight / 2);
                                        ctx.rotate((rotation * Math.PI) / 180);
                                        ctx.drawImage(img, -imgWidth / 2, -imgHeight / 2, imgWidth, imgHeight);
                                        ctx.restore();
                                    }
                                }
                            } else {
                                const pos = getWatermarkPosition(width, height, imgWidth, imgHeight, position);
                                ctx.save();
                                ctx.translate(pos.x + imgWidth / 2, pos.y + imgHeight / 2);
                                const finalRotation = manualMode ? watermarkTransform.rotation : rotation;
                                ctx.rotate((finalRotation * Math.PI) / 180);
                                ctx.drawImage(img, -imgWidth / 2, -imgHeight / 2, imgWidth, imgHeight);
                                ctx.restore();
                            }
                            ctx.restore();
                            resolve();
                        };
                    });
                }

                ctx.restore();
            };

            const processImage = async (file) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        img.src = e.target.result;
                        img.onload = async () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');

                            ctx.drawImage(img, 0, 0);
                            await applyWatermarkToCanvas(ctx, canvas.width, canvas.height);

                            canvas.toBlob((blob) => {
                                resolve({
                                    blob,
                                    name: file.name.replace(/\.[^/.]+$/, '-watermarked.png')
                                });
                            }, 'image/png');
                        };
                    };
                    reader.readAsDataURL(file);
                });
            };

            const processPDF = async (file) => {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                const pages = pdfDoc.getPages();

                for (const page of pages) {
                    const { width, height } = page.getSize();

                    if (watermarkType === 'text') {
                        await loadGoogleFont(selectedFont);
                        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                        const rgbColor = PDFLib.rgb(
                            parseInt(fontColor.slice(1, 3), 16) / 255,
                            parseInt(fontColor.slice(3, 5), 16) / 255,
                            parseInt(fontColor.slice(5, 7), 16) / 255
                        );

                        const actualFontSize = manualMode ? (fontSize * watermarkTransform.width / 200) : fontSize;

                        if (tiled) {
                            const spacing = actualFontSize * 3;
                            for (let x = 0; x < width; x += spacing) {
                                for (let y = 0; y < height; y += spacing) {
                                    page.drawText(watermarkText, {
                                        x: x,
                                        y: y,
                                        size: actualFontSize,
                                        font: font,
                                        color: rgbColor,
                                        opacity: opacity / 100,
                                        rotate: PDFLib.degrees(rotation)
                                    });
                                }
                            }
                        } else {
                            const textWidth = font.widthOfTextAtSize(watermarkText, actualFontSize);
                            const pos = getWatermarkPosition(width, height, textWidth, actualFontSize, position);
                            const finalRotation = manualMode ? watermarkTransform.rotation : rotation;

                            page.drawText(watermarkText, {
                                x: pos.x,
                                y: height - pos.y - actualFontSize,
                                size: actualFontSize,
                                font: font,
                                color: rgbColor,
                                opacity: opacity / 100,
                                rotate: PDFLib.degrees(finalRotation)
                            });
                        }
                    } else if (watermarkType === 'image' && watermarkImage) {
                        const imgBytes = await fetch(watermarkImage).then(r => r.arrayBuffer());
                        let pdfImage;

                        if (watermarkImage.includes('png')) {
                            pdfImage = await pdfDoc.embedPng(imgBytes);
                        } else {
                            pdfImage = await pdfDoc.embedJpg(imgBytes);
                        }

                        const imgScale = manualMode ? (watermarkTransform.width / 400) : 0.5;
                        const imgDims = pdfImage.scale(imgScale);

                        if (tiled) {
                            const spacing = imgDims.width * 2;
                            for (let x = 0; x < width; x += spacing) {
                                for (let y = 0; y < height; y += spacing) {
                                    page.drawImage(pdfImage, {
                                        x: x,
                                        y: y,
                                        width: imgDims.width,
                                        height: imgDims.height,
                                        opacity: opacity / 100
                                    });
                                }
                            }
                        } else {
                            const pos = getWatermarkPosition(width, height, imgDims.width, imgDims.height, position);
                            page.drawImage(pdfImage, {
                                x: pos.x,
                                y: height - pos.y - imgDims.height,
                                width: imgDims.width,
                                height: imgDims.height,
                                opacity: opacity / 100
                            });
                        }
                    }
                }

                const pdfBytes = await pdfDoc.save();
                return {
                    blob: new Blob([pdfBytes], { type: 'application/pdf' }),
                    name: file.name.replace(/\.[^/.]+$/, '-watermarked.pdf')
                };
            };

            const handleDownload = async () => {
                if (files.length === 0) return;

                setProcessing(true);
                const processedFiles = [];

                for (const file of files) {
                    try {
                        let result;
                        if (file.type === 'application/pdf') {
                            result = await processPDF(file);
                        } else {
                            result = await processImage(file);
                        }
                        processedFiles.push(result);
                    } catch (error) {
                        console.error('Error processing file:', error);
                    }
                }

                if (processedFiles.length === 1) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(processedFiles[0].blob);
                    link.download = processedFiles[0].name;
                    link.click();
                } else if (processedFiles.length > 1) {
                    const zip = new JSZip();
                    processedFiles.forEach(file => {
                        zip.file(file.name, file.blob);
                    });

                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = 'watermarked-files.zip';
                    link.click();
                }

                setProcessing(false);
            };

            const PreviewCanvas = () => {
                const canvasRef = useRef(null);

                useEffect(() => {
                    if (!previewUrls[currentPreview] || !canvasRef.current) return;

                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = async () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);

                        if (!manualMode) {
                            await applyWatermarkToCanvas(ctx, canvas.width, canvas.height);
                        }
                    };

                    img.src = previewUrls[currentPreview];
                }, [previewUrls, currentPreview, watermarkText, watermarkImage, watermarkType,
                    fontSize, fontColor, opacity, rotation, bold, italic, letterSpacing,
                    position, tiled, layerMode, selectedFont, manualMode, watermarkTransform]);

                return (
                    <canvas
                        ref={canvasRef}
                        className="max-w-full h-auto mx-auto rounded-lg shadow-lg"
                        style={{ maxHeight: manualMode ? 'none' : '500px' }}
                    />
                );
            };

            const ManualWatermarkOverlay = () => {
                if (!manualMode || !previewUrls[currentPreview]) return null;

                const watermarkStyle = {
                    left: `${watermarkTransform.x}px`,
                    top: `${watermarkTransform.y}px`,
                    width: `${watermarkTransform.width}px`,
                    height: `${watermarkTransform.height}px`,
                    transform: `rotate(${watermarkTransform.rotation}deg)`,
                    fontSize: `${fontSize * watermarkTransform.width / 200}px`,
                    fontFamily: selectedFont,
                    fontWeight: bold ? 'bold' : 'normal',
                    fontStyle: italic ? 'italic' : 'normal',
                    color: fontColor,
                    opacity: opacity / 100,
                    letterSpacing: `${letterSpacing}px`
                };

                return (
                    <div
                        ref={watermarkRef}
                        className="watermark-overlay"
                        style={watermarkStyle}
                        onMouseDown={handleWatermarkMouseDown}
                    >
                        {watermarkType === 'text' ? (
                            <span className="pointer-events-none select-none">
                                {watermarkText}
                            </span>
                        ) : watermarkImage ? (
                            <img
                                src={watermarkImage}
                                alt="Watermark"
                                className="w-full h-full object-contain pointer-events-none"
                            />
                        ) : null}

                        {/* Resize handles */}
                        <div className="resize-handle nw" onMouseDown={(e) => { e.stopPropagation(); setIsResizing('nw'); }}></div>
                        <div className="resize-handle ne" onMouseDown={(e) => { e.stopPropagation(); setIsResizing('ne'); }}></div>
                        <div className="resize-handle sw" onMouseDown={(e) => { e.stopPropagation(); setIsResizing('sw'); }}></div>
                        <div className="resize-handle se" onMouseDown={(e) => { e.stopPropagation(); setIsResizing('se'); }}></div>

                        {/* Rotate handle */}
                        <div
                            className="rotate-handle"
                            onMouseDown={(e) => {
                                e.stopPropagation();
                                setIsRotating(true);
                                const rect = previewContainerRef.current.getBoundingClientRect();
                                const centerX = watermarkTransform.x + watermarkTransform.width / 2;
                                const centerY = watermarkTransform.y + watermarkTransform.height / 2;
                                setDragStart({ x: centerX, y: centerY });
                            }}
                        ></div>
                    </div>
                );
            };

            const filteredFonts = googleFonts.filter(font =>
                font.family.toLowerCase().includes(searchFont.toLowerCase())
            );

            return (
                <div className="min-h-screen gradient-bg">
                    {/* Header */}
                    <header className="glass border-b border-white/20 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center space-x-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
                                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a6 6 0 00-12 0v4a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <h1 className="text-2xl font-bold text-primary">
                                    WatermarkPro
                                </h1>
                            </div>
                            <button
                                onClick={() => setDarkMode(!darkMode)}
                                className="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-primary"
                                title="Toggle theme"
                            >
                                {darkMode ? '☀️' : '🌙'}
                            </button>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="max-w-7xl mx-auto px-4 py-8">
                        <div className="grid lg:grid-cols-3 gap-6">
                            {/* Controls Panel */}
                            <div className="lg:col-span-1 space-y-4">
                                {/* File Upload */}
                                <div className="glass rounded-xl p-6 backdrop-blur-md">
                                    <h3 className="text-lg font-semibold mb-4 text-primary">
                                        Upload Files
                                    </h3>
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        multiple
                                        accept=".pdf,.jpg,.jpeg,.png"
                                        onChange={handleFileUpload}
                                        className="hidden"
                                    />
                                    <button
                                        onClick={() => fileInputRef.current?.click()}
                                        className="w-full py-3 px-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200"
                                    >
                                        Choose Files
                                    </button>
                                    {files.length > 0 && (
                                        <div className="mt-3 text-sm text-secondary">
                                            {files.length} file(s) selected
                                        </div>
                                    )}
                                </div>

                                {/* Watermark Type */}
                                <div className="glass rounded-xl p-6 backdrop-blur-md">
                                    <h3 className="text-lg font-semibold mb-4 text-primary">
                                        Watermark Type
                                    </h3>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => setWatermarkType('text')}
                                            className={`flex-1 py-2 px-4 rounded-lg transition-all ${watermarkType === 'text'
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white/20 text-secondary hover:bg-white/30'
                                                }`}
                                        >
                                            Text
                                        </button>
                                        <button
                                            onClick={() => setWatermarkType('image')}
                                            className={`flex-1 py-2 px-4 rounded-lg transition-all ${watermarkType === 'image'
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white/20 text-secondary hover:bg-white/30'
                                                }`}
                                        >
                                            Image/Logo
                                        </button>
                                    </div>
                                </div>

                                {/* Manual Control Mode */}
                                <div className="glass rounded-xl p-6 backdrop-blur-md">
                                    <h3 className="text-lg font-semibold mb-4 text-primary">
                                        Watermark Mode
                                    </h3>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => setManualMode(false)}
                                            className={`flex-1 py-2 px-4 rounded-lg transition-all text-sm ${!manualMode
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white/20 text-secondary hover:bg-white/30'
                                                }`}
                                        >
                                            Auto Position
                                        </button>
                                        <button
                                            onClick={() => setManualMode(true)}
                                            className={`flex-1 py-2 px-4 rounded-lg transition-all text-sm ${manualMode
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white/20 text-secondary hover:bg-white/30'
                                                }`}
                                        >
                                            Manual Control
                                        </button>
                                    </div>
                                    {manualMode && (
                                        <p className="mt-2 text-xs text-tertiary">
                                            Drag, resize and rotate the watermark in the preview
                                        </p>
                                    )}
                                </div>

                                {/* Text Settings */}
                                {watermarkType === 'text' && (
                                    <div className="glass rounded-xl p-6 backdrop-blur-md space-y-4">
                                        <h3 className="text-lg font-semibold text-primary">
                                            Text Settings
                                        </h3>

                                        <div>
                                            <label className="block text-sm font-medium mb-2 text-secondary">
                                                Watermark Text
                                            </label>
                                            <input
                                                type="text"
                                                value={watermarkText}
                                                onChange={(e) => setWatermarkText(e.target.value)}
                                                className="w-full px-3 py-2 rounded-lg input-field"
                                                placeholder="Enter watermark text"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-2 text-secondary">
                                                Font Family ({googleFonts.length}+ fonts available)
                                            </label>
                                            <input
                                                type="text"
                                                placeholder="Search fonts..."
                                                value={searchFont}
                                                onChange={(e) => setSearchFont(e.target.value)}
                                                className="w-full px-3 py-2 rounded-lg input-field mb-2"
                                            />
                                            <div className="max-h-32 overflow-y-auto space-y-1 border border-white/20 rounded-lg">
                                                {loadingFonts ? (
                                                    <div className="p-3 text-center text-tertiary">
                                                        Loading fonts...
                                                    </div>
                                                ) : (
                                                    filteredFonts.slice(0, 20).map(font => (
                                                        <button
                                                            key={font.family}
                                                            onClick={() => {
                                                                setSelectedFont(font.family);
                                                                loadGoogleFont(font.family);
                                                                setSearchFont('');
                                                            }}
                                                            className={`w-full text-left px-3 py-2 text-sm font-item rounded transition-all ${selectedFont === font.family
                                                                    ? 'bg-purple-500/30 text-primary'
                                                                    : 'text-secondary hover:text-primary'
                                                                }`}
                                                            style={{ fontFamily: loadedFonts.has(font.family) ? font.family : 'inherit' }}
                                                        >
                                                            {font.family}
                                                            <span className="text-xs text-tertiary ml-2">
                                                                ({font.category})
                                                            </span>
                                                        </button>
                                                    ))
                                                )}
                                            </div>
                                        </div>

                                        <div className="flex space-x-2">
                                            <button
                                                onClick={() => setBold(!bold)}
                                                className={`flex-1 py-2 px-4 rounded-lg transition-all ${bold ? 'bg-purple-500 text-white' : 'bg-white/20 text-secondary hover:bg-white/30'
                                                    }`}
                                            >
                                                <strong>B</strong>
                                            </button>
                                            <button
                                                onClick={() => setItalic(!italic)}
                                                className={`flex-1 py-2 px-4 rounded-lg transition-all ${italic ? 'bg-purple-500 text-white' : 'bg-white/20 text-secondary hover:bg-white/30'
                                                    }`}
                                            >
                                                <em>I</em>
                                            </button>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-2 text-secondary">
                                                Color
                                            </label>
                                            <input
                                                type="color"
                                                value={fontColor}
                                                onChange={(e) => setFontColor(e.target.value)}
                                                className="w-full h-10 rounded-lg cursor-pointer border border-white/20"
                                            />
                                        </div>
                                    </div>
                                )}

                                {/* Image Settings */}
                                {watermarkType === 'image' && (
                                    <div className="glass rounded-xl p-6 backdrop-blur-md space-y-4">
                                        <h3 className="text-lg font-semibold text-primary">
                                            Logo Settings
                                        </h3>
                                        <input
                                            ref={logoInputRef}
                                            type="file"
                                            accept=".png,.jpg,.jpeg,.svg"
                                            onChange={handleLogoUpload}
                                            className="hidden"
                                        />
                                        <button
                                            onClick={() => logoInputRef.current?.click()}
                                            className="w-full py-2 px-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:shadow-lg transition-all"
                                        >
                                            Upload Logo
                                        </button>
                                        {watermarkImage && (
                                            <div className="mt-2">
                                                <img
                                                    src={watermarkImage}
                                                    alt="Logo preview"
                                                    className="w-20 h-20 object-contain mx-auto rounded-lg bg-white/10 p-2"
                                                />
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Common Settings */}
                                <div className="glass rounded-xl p-6 backdrop-blur-md space-y-4">
                                    <h3 className="text-lg font-semibold text-primary">
                                        Appearance
                                    </h3>

                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-secondary">
                                            Size: {fontSize}px
                                        </label>
                                        <input
                                            type="range"
                                            min="10"
                                            max="200"
                                            value={fontSize}
                                            onChange={(e) => setFontSize(parseInt(e.target.value))}
                                            className="w-full"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-2 text-secondary">
                                            Opacity: {opacity}%
                                        </label>
                                        <input
                                            type="range"
                                            min="10"
                                            max="100"
                                            value={opacity}
                                            onChange={(e) => setOpacity(parseInt(e.target.value))}
                                            className="w-full"
                                        />
                                    </div>

                                    {!manualMode && (
                                        <div>
                                            <label className="block text-sm font-medium mb-2 text-secondary">
                                                Rotation: {rotation}°
                                            </label>
                                            <input
                                                type="range"
                                                min="-180"
                                                max="180"
                                                value={rotation}
                                                onChange={(e) => setRotation(parseInt(e.target.value))}
                                                className="w-full"
                                            />
                                        </div>
                                    )}

                                    {watermarkType === 'text' && (
                                        <div>
                                            <label className="block text-sm font-medium mb-2 text-secondary">
                                                Letter Spacing: {letterSpacing}px
                                            </label>
                                            <input
                                                type="range"
                                                min="-10"
                                                max="20"
                                                value={letterSpacing}
                                                onChange={(e) => setLetterSpacing(parseInt(e.target.value))}
                                                className="w-full"
                                            />
                                        </div>
                                    )}
                                </div>

                                {/* Position Settings */}
                                {!manualMode && (
                                    <div className="glass rounded-xl p-6 backdrop-blur-md space-y-4">
                                        <h3 className="text-lg font-semibold text-primary">
                                            Position
                                        </h3>

                                        <div className="grid grid-cols-3 gap-2">
                                            {['top-left', 'top-center', 'top-right',
                                                'center-left', 'center', 'center-right',
                                                'bottom-left', 'bottom-center', 'bottom-right'].map(pos => (
                                                    <button
                                                        key={pos}
                                                        onClick={() => setPosition(pos)}
                                                        className={`py-2 px-2 text-xs rounded-lg transition-all ${position === pos
                                                                ? 'bg-purple-500 text-white'
                                                                : 'bg-white/20 text-secondary hover:bg-white/30'
                                                            }`}
                                                    >
                                                        {pos.split('-').map(word =>
                                                            word.charAt(0).toUpperCase() + word.slice(1)
                                                        ).join(' ')}
                                                    </button>
                                                ))}
                                        </div>

                                        <button
                                            onClick={() => setPosition('diagonal')}
                                            className={`w-full py-2 px-4 rounded-lg transition-all ${position === 'diagonal'
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white/20 text-secondary hover:bg-white/30'
                                                }`}
                                        >
                                            Diagonal
                                        </button>

                                        <button
                                            onClick={() => setTiled(!tiled)}
                                            className={`w-full py-2 px-4 rounded-lg transition-all ${tiled
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white/20 text-secondary hover:bg-white/30'
                                                }`}
                                        >
                                            {tiled ? '✓ ' : ''}Tiled Pattern
                                        </button>
                                    </div>
                                )}

                                {/* Layer Mode */}
                                <div className="glass rounded-xl p-6 backdrop-blur-md">
                                    <h3 className="text-lg font-semibold mb-4 text-primary">
                                        Layer Mode
                                    </h3>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={() => setLayerMode('above')}
                                            className={`flex-1 py-2 px-4 rounded-lg transition-all ${layerMode === 'above'
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white/20 text-secondary hover:bg-white/30'
                                                }`}
                                        >
                                            Above
                                        </button>
                                        <button
                                            onClick={() => setLayerMode('blended')}
                                            className={`flex-1 py-2 px-4 rounded-lg transition-all ${layerMode === 'blended'
                                                    ? 'bg-purple-500 text-white'
                                                    : 'bg-white/20 text-secondary hover:bg-white/30'
                                                }`}
                                        >
                                            Blended
                                        </button>
                                    </div>
                                </div>

                                {/* Download Button */}
                                <button
                                    onClick={handleDownload}
                                    disabled={files.length === 0 || processing}
                                    className={`w-full py-4 px-6 rounded-xl font-semibold transition-all transform hover:scale-105 ${files.length === 0 || processing
                                            ? 'bg-gray-400 cursor-not-allowed text-gray-200'
                                            : 'bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:shadow-xl'
                                        }`}
                                >
                                    {processing ? (
                                        <span className="flex items-center justify-center">
                                            <svg className="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Processing...
                                        </span>
                                    ) : (
                                        `Download ${files.length > 1 ? `All (${files.length} files)` : ''}`
                                    )}
                                </button>
                            </div>

                            {/* Preview Panel */}
                            <div className="lg:col-span-2">
                                <div className="glass rounded-xl p-6 backdrop-blur-md">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-semibold text-primary">
                                            Preview
                                        </h3>
                                        {files.length > 1 && (
                                            <div className="flex items-center space-x-2">
                                                <button
                                                    onClick={() => setCurrentPreview(Math.max(0, currentPreview - 1))}
                                                    disabled={currentPreview === 0}
                                                    className="p-2 rounded-lg bg-white/20 disabled:opacity-50 text-primary hover:bg-white/30 transition-colors"
                                                >
                                                    ←
                                                </button>
                                                <span className="text-sm text-secondary">
                                                    {currentPreview + 1} / {files.length}
                                                </span>
                                                <button
                                                    onClick={() => setCurrentPreview(Math.min(files.length - 1, currentPreview + 1))}
                                                    disabled={currentPreview === files.length - 1}
                                                    className="p-2 rounded-lg bg-white/20 disabled:opacity-50 text-primary hover:bg-white/30 transition-colors"
                                                >
                                                    →
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <div
                                        ref={previewContainerRef}
                                        className="preview-container rounded-lg p-4 min-h-[400px] flex items-center justify-center relative"
                                    >
                                        {previewUrls.length > 0 ? (
                                            <>
                                                <PreviewCanvas />
                                                <ManualWatermarkOverlay />
                                            </>
                                        ) : (
                                            <div className="text-center">
                                                <svg className="w-24 h-24 mx-auto mb-4 text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                <p className="text-secondary mb-2">No files uploaded</p>
                                                <p className="text-sm text-tertiary">
                                                    Upload PDF, JPG, or PNG files to start
                                                </p>
                                            </div>
                                        )}
                                    </div>

                                    {files.length > 0 && (
                                        <div className="mt-4 p-3 bg-white/10 rounded-lg">
                                            <p className="text-sm text-secondary">
                                                <span className="font-semibold">Current file:</span> {files[currentPreview]?.name}
                                            </p>
                                        </div>
                                    )}
                                </div>

                                {/* Features Grid */}
                                <div className="grid grid-cols-2 gap-4 mt-6">
                                    <div className="glass rounded-xl p-4 backdrop-blur-md">
                                        <div className="flex items-center space-x-3">
                                            <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center text-white">
                                                🔒
                                            </div>
                                            <div>
                                                <h4 className="font-semibold text-primary">100% Private</h4>
                                                <p className="text-xs text-tertiary">Files never leave your browser</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="glass rounded-xl p-4 backdrop-blur-md">
                                        <div className="flex items-center space-x-3">
                                            <div className="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center text-white">
                                                ⚡
                                            </div>
                                            <div>
                                                <h4 className="font-semibold text-primary">Fast & Efficient</h4>
                                                <p className="text-xs text-tertiary">All processing done locally</p> 
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WatermarkApp />
